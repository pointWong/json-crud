<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>添加或修改</title>
  <link rel="stylesheet" href="/style/css/index.css">
</head>

<body>
  <div style="display: flex;align-items: center;justify-content: center;">
    <div style="padding: 20px;">
      <div id="columns"></div>
      <div class="display-flex item-center m-t-20">
        <div>字段:</div>
        <input id="propname" type="text" placeholder="字段名" class="m-l-10">
        <button class="m-l-10" id="addprop">增加</button>
      </div>
      <div style="display: flex;justify-content: center;margin-top: 20px;">
        <button id="button">提交</button>
      </div>
    </div>
  </div>
</body>
<script src="/js/request.js"></script>
<script>
  const query = location.search
  const params = getPa(query)
  const cr = localStorage.getItem('currentRow')
  const upId = localStorage.getItem('upId')
  let row = { upId, child: [] }

  let columns = []
  try {
    columns = JSON.parse(localStorage.getItem('columns')) || []
    if(params.type ==="POST" && !columns.includes('upId')){
      columns = [...columns, 'upId']
    }

  } catch (error) {
    console.log("🚀 ~ error:", error)
  }

  function getPa(query) {
    return Object.fromEntries(query.replace('?', '').split('&').map(item => item.split('=')))
  }

  function setField(row) {
    let result = ''
    for (let i = 0; i < columns.length; i++) {
      const col = columns[i]
      result += `<div id="${col}-ctn">
        <fieldset>
          <legend>${col}</legend>
          <input value="${row && row[col] ? row[col] : ''}" style="width: 450px;height: 30px;" id="${col}" type="text" placeholder="${col}">
        </fieldset>
          <div class="display-flex justify-end m-t-4">
            <button onclick="javascript:deleteField('${col}');">删除</button>
          </div>
        </div>`
    }
    document.getElementById('columns').innerHTML = result
  }

  if (params.type == 'PUT') {
    row = JSON.parse(cr)
    setField(row)
  } else {
    setField(row)
  }

  document.getElementById('addprop').addEventListener('click', () => {
    const propnameEle = document.getElementById('propname')
    let key = propnameEle.value || prompt('请输入字段名')
    if(!key) return
    columns = [...columns, key]
    setField()
    propnameEle.value = ""
  })

  function getData() {
    let data = {}
    for (let i = 0; i < columns.length; i++) {
      let prop = columns[i]
      data[prop] = document.getElementById(prop).value
    }
    return data
  }

  document.getElementById('button').addEventListener('click', async () => {
    let data = getData()
    if (!data.id) {
      data.id = data.cityId || new Date().toISOString().replace(/[^\d]/g,'').slice(0,14)
    }
    if(!data.upId){
      data.upId = '0'
    }
    await ajaxRequest(params.type, `${params.pi}.json`, { ...data, child: row.child })
    parent.window.reloadData()
  })

  function deleteField(col){
    const child = document.getElementById(`${col}-ctn`)
    columns = columns.filter(item => item != col)
    document.getElementById('columns').removeChild(child)
  }
</script>

</html>